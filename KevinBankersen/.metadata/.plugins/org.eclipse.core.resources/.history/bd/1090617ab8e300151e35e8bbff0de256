package eu.bankersen.kevin.ql.typechecker;

import java.util.HashSet;
import java.util.Set;

import eu.bankersen.kevin.ql.ast.form.Form;
import eu.bankersen.kevin.ql.typechecker.analytics.CyclicAnalyzer;
import eu.bankersen.kevin.ql.typechecker.analytics.TypeAnalyzer;
import eu.bankersen.kevin.ql.typechecker.errors.TypeCheckError;
import eu.bankersen.kevin.ql.typechecker.symboltable.SymbolTable;
import eu.bankersen.kevin.ql.typechecker.symboltable.SymbolTableBuilder;
import eu.bankersen.kevin.ql.typechecker.warnings.TypeCheckWarning;

public class TypeChecker {
    
    private final Form form;
    private final SymbolTable symbolTable;
    private final Set<TypeCheckError> errorList;
    private final Set<TypeCheckWarning> warningList;
    
    public TypeChecker(Form form) throws TypeCheckException {
	this.errorList = new HashSet<>();
	this.warningList = new HashSet<>();
	this.form = form;
	
	SymbolTableBuilder builder = new SymbolTableBuilder(form);
	this.symbolTable = builder.getSymbolTable();
	
	warningList.addAll(builder.getWarnings());
	
	errorList.addAll(builder.getErrors());
		
	errorList.addAll(new TypeAnalyzer(symbolTable, form).getErrors());
	errorList.addAll(new CyclicAnalyzer(form, symbolTable).getErrors());
	
	if (!errorList.isEmpty()) {
	    throw new TypeCheckException(warningList, errorList, symbolTable);
	}
    }
    
    public SymbolTable getSymbolTable() {
	return form.evalForm(symbolTable);
    }

}
