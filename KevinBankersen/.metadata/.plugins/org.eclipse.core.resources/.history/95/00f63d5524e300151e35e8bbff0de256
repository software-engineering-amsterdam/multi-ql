package eu.bankersen.kevin.ql.context;

import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import eu.bankersen.kevin.ql.ast.form.Form;
import eu.bankersen.kevin.ql.context.errors.ContextBuildException;
import eu.bankersen.kevin.ql.context.errors.TypeCheckingError;
import eu.bankersen.kevin.ql.context.symboltable.Symbol;
import eu.bankersen.kevin.ql.context.symboltable.SymbolTable;
import eu.bankersen.kevin.ql.context.symboltable.SymbolTableBuilder;
import eu.bankersen.kevin.ql.context.symboltable.SymbolTableBuilderNew;
import eu.bankersen.kevin.ql.context.typeanalyzer.Context;
import eu.bankersen.kevin.ql.context.typeanalyzer.TypeAnalyzer;

public class TypeChecker {
    
    private final Form form;
    private final SymbolTable symbolTable;
    private final Set<TypeCheckingError> errorList;
    
    public TypeChecker(Form form) throws ContextBuildException {
	this.errorList = new HashSet<>();
	this.form = form;
	
	//SymbolTableBuilder builder = new SymbolTableBuilder();
	//form.process(builder);
	
	SymbolTableBuilderNew builder = new SymbolTableBuilderNew(form);
	
	
	this.symbolTable = builder.getSymbolTable();
	errorList.addAll(builder.getErrors());
	
	//errorList.addAll(new Context(form, symbolTable).getErrors());
	
	errorList.addAll(new TypeAnalyzer(symbolTable).getErrors());
	
	if (errorList.size() > 0) {
	    throw new ContextBuildException(errorList);
	}
    }
    
    public SymbolTable getSymbolTable() {
	return form.evalForm(symbolTable);
    }
    
    private SymbolTable convertRawSymbolTable() {
	return new SymbolTable();
    }

}
