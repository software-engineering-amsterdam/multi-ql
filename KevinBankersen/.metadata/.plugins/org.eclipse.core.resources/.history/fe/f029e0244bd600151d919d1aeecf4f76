package eu.bankersen.kevin.ql.ast;

import eu.bankersen.kevin.ql.ast.expr.Expr;
import eu.bankersen.kevin.ql.context.Context;

public class Variable {

    private final String name;
    private final Type type;
    private final int line;
    private final Context context;
    private Expr expr;

    public Variable(final String name, final Type type, final Expr expr, final int line) {
	context = Context.getInstance();
	this.name = name;
	this.type = type;
	this.expr = expr;
	this.line = line;
    }

    public final String getName() {
	return name;
    }

    public Type getType() {
	return type;
    }

    public void checkType() {

	if (context.checkID(name)) {
	    context.addError("TYPE_ERROR @Line " + line 
		    			+ " question " + name + " already defined!");
	} else {
	    context.addSymbol(name, type);
	}

	expr.checkType();
	
	if (!expr.getType().equals(type)) {
	    context.addError("TYPE_ERROR @Line " + line 
		    			+ ": expected " + type 
		    			+ " got " + expr.getType() + "!");
	}
    }

    public Object getValue() {
	return context.getSymbol(name).getValue();
    }

    public final String toString() {
	return this.getName() + ": " + this.getType() + "=" + this.getValue();
    }

    public void eval() {

	try {
	    Object value = expr.eval();
	    context.updateSymbol(name, value);
	} catch (NullPointerException e) {
	    context.updateSymbol(name, null);
	}
    }
}
