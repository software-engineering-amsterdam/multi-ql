package eu.bankersen.kevin.ql;

import java.io.IOException;

import com.esotericsoftware.minlog.Log;
import eu.bankersen.kevin.ql.ast.form.Form;
import eu.bankersen.kevin.ql.context.Context;
import eu.bankersen.kevin.ql.parser.ANTLRParseException;
import eu.bankersen.kevin.ql.parser.FormParser;
import eu.bankersen.kevin.ql.util.CustomLogger;
import eu.bankersen.kevin.ql.util.FileReader;

/**
 * Hello world!
 *
 */
public final class App {
    
    private App() {
    }

    public static void main(String[] args) {
	Log.INFO(); // Set log level
	Log.setLogger(new CustomLogger()); // Our custom logger.

	System.out.println("Welcome to the Questionnaire Language (QL)!\n");

	String form;

	int selectedForm = 1;
	String resource;

	switch(selectedForm) {
	default: resource = "resources/Tax.form";
	case 1 : resource = "resources/Tax2.form";
	case 2 : resource = "resources/Tax3.form";
	}

	try { // Currently the top level so here we catch exceptions.
	    form = new FileReader().read(resource);
	} catch (IOException e) {
	    Log.error("Unable to read file, Terminating");
	    System.exit(1);
	    form = null;
	}

	FormParser parser;
	Form parsedForm = null;
	
	try {
	    parser = new FormParser(form);
	    parsedForm = parser.getForm();
	    Log.info("File Parsed");
	} catch (ANTLRParseException e) {
	    e.getErrors().forEach(error -> Log.error("Line " + error[0] + ": " + error[1]));
	    Log.error("Parse Errors, Terminating!");
	    System.exit(1);
	}

	// Trying to type check.
	Log.info("Type Check Start");
	Context context = parsedForm.checkType();
	if (context.getErrors().size() > 0) {
	    context.getErrors().forEach(error -> Log.error(error.toString()));
	    Log.error("Type Check error, Terminating!");
	    System.exit(1);
	} else {
	    Log.info("Type Check succesful");
	}


	Log.info("\n\n***********************\n"
		   + "* Doing random  stuff *\n"
		   + "***********************\n");

	if (selectedForm == 1) {

	    Log.info("Starting State");
	    parsedForm.evalForm(context); // Initialize the form
	    Log.info(parsedForm.toString());

	    Log.info("Answer european: yes");
	    context.updateSymbol("European", new Boolean(true));
	    context = parsedForm.evalForm(context);
	    Log.info(parsedForm.toString());

	    Log.info("Answer name: Kevin");
	    context.updateSymbol("name", new String("Kevin"));
	    context = parsedForm.evalForm(context);
	    Log.info(parsedForm.toString());

	    Log.info("Answer age: 26");
	    context.updateSymbol("age", new Integer(26));
	    context = parsedForm.evalForm(context);
	    Log.info(parsedForm.toString());

	    Integer age = 4;
	    Log.info("Answer startSchool: " + age.toString());
	    context.updateSymbol("startSchool", age);
	    context = parsedForm.evalForm(context);
	    Log.info(parsedForm.toString());

	    Log.info(parsedForm.toString());
	}

    }
}
